<html>

<link href="chat.css" rel="stylesheet" type="text/css" />

<style type="text/css">
html, body {
  width:  100%;
  height: 100%;
}

#canvas {
  background-color: #333333;
  position: absolute;
  top: 35px;
}

#status {
  color: #FFFFFF;
  position: absolute;
  cursor: default;
  font-family: Helvetica, Verdana, sans-serif;
  font-weight: bold;
  margin: 10px;
  top: 30px;
}

#controls {
  background-color: #AAAAAA;
  position: absolute;
  font-family: Helvetica, Verdana, sans-serif;
  font-weight: bold;
  font-size: smaller;
  padding: 3px;
  width: 594px;
  height: 25px;
}

select {
  font-family: monospace;
  font-size: medium;
}

* {
  padding:0;
  margin:0;
}
</style>

<script>

var content;
var Signaling = top.Signaling;
var chatHistory;
var chatMessage;

var selfView;
var peerView = new Array();
//var addButton;

</script>

<script src="UnionDraw.js"></script>

<script>

/*
window.onload = function() {

    chatHistory  = document.getElementById('chatHistory');
    chatMessage  = document.getElementById('chatMessage');
}*/

function startChat() {
    console.log("inside start chat");
    for(chatIndex in Signaling.chatReady) {
	if(Signaling.chatReady[chatIndex] == true) {
	    //content.hidden = false;
	    //document.getElementById('videoForm').hidden = false;
	    
	    Signaling.Peer[chatIndex].onmessage   = receiveChatMessage;
	    //Signaling.Peer[chatIndex].onaddstream = receiveVideoStream;
	    
	    Signaling.Peer[chatIndex].onaddstream = function receiveVideoStream(e) {
    		peerView[chatIndex].src = webkitURL.createObjectURL(e.stream);
	    };

	    newPeerVideo = document.createElement('video');
	    newPeerVideo.setAttribute('id', "peer"+chatIndex);
	    newPeerVideo.setAttribute('width', '320');
	    newPeerVideo.setAttribute('height', '240');
	    newPeerVideo.setAttribute('autoplay',true);
	    newPeerVideo.setAttribute('controls',true);
	    document.getElementById('videos').appendChild(newPeerVideo);
            peerView[chatIndex] = document.getElementById("peer"+chatIndex);

	    if(chatHistory.value && chatHistory.value.length != 0) {
		var hist = { prevHistory : chatHistory.value };
		Signaling.Peer[chatIndex].send(JSON.stringify(hist));
	    }
	    Signaling.chatReady[chatIndex] = false;
	 
	}
    }
}


/* -------------------------------------------------------------------------
 * Instant messaging
 * ------------------------------------------------------------------------- */

function receiveChatMessage(e) {
    var contents = JSON.parse(e.data);
    
    if(contents.command)
	{
		var path = contents.path;
		console.log("command is : " + contents.command + "path is :" + contents.path);
		if(contents.command == DrawingCommands.MOVE_TO)
		{
			console.log("a move command is received");
			handleMoveMessage(path);
		}
		else
		{
			console.log("a line to command is received");
			handlePathMessage(path);
		}		
	}
    
    if(contents.prevHistory) {
	if(!chatHistory.value || chatHistory.value.length == 0) { 
	    chatHistory.value += contents.prevHistory;
	}
    }
    else {
	chatHistory.value += contents.message + "\n";
    }
}

function sendChatMessage() {
    chatMessage.value = Signaling.fifoId + " : " + chatMessage.value;
    chatHistory.value +=  chatMessage.value + "\n";
    var contents = { message : chatMessage.value };
    for(i in Signaling.Peer) {
	Signaling.Peer[i].send(JSON.stringify(contents));
    }
    chatMessage.value = "";
}

/* -------------------------------------------------------------------------
 * Voice & video
 * ------------------------------------------------------------------------- */

function requestSelfVideo() {
    navigator.webkitGetUserMedia('audio,video user', function(stream) {
        selfView.muted = true;
        selfView.src = webkitURL.createObjectURL(stream);
        Signaling.Peer.addStream(stream);
    });
    addButton.disabled = "true";
}

</script>

<body>

<!--Drop down menus for selecting line thickness and color-->
  <div id="controls">
    Size:
    <select id="thickness" class="fixed">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="10">10</option>
      <option value="20">20</option>
    </select>

    Color:
    <select id="color">
      <option value="#FFFFFF">#FFFFFF</option>
      <option value="#AAAAAA">#AAAAAA</option>
      <option value="#666666">#666666</option>
      <option value="#000000">#000000</option>
      <option value="#9BA16C">#9BA16C</option>
      <option value="#CC8F2B">#CC8F2B</option>
      <option value="#63631D">#63631D</option>
    </select>
  </div> 
  
  <!--The canvas where drawings will be displayed-->
  <canvas id="canvas"></canvas>
  <br/>
  <br/>
  <br/>
  <br/>
  
  <hr />
    
  <div id="chat">
    <form id="chatForm" action="javascript:sendChatMessage();">
      Text chat
      <input id="chatMessage" type="text" size="40">
      <input type="submit" value="send message">
    </form>
    <textarea id="chatHistory" readonly cols="80" rows="6"></textarea>
  </div>
  
  <hr />
  
    <div id="videos">
      <video id="selfView"
	     width="320" height="240" autoplay controls>
      </video>
    </div>
    
    <input id="addButton" type="button" value="add webcam" onclick="requestSelfVideo();">
    


</body>
</html> 
